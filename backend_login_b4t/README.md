# Backend Login B4T - Setup & API Documentation

Backend RESTful API untuk sistem autentikasi dengan role-based access control, dibangun dengan Laravel 8 dan Laravel Sanctum.

---

## ğŸ“‹ Table of Contents

- [Quick Start](#-quick-start)
- [Prerequisites](#-prerequisites)
- [Setup Instructions](#-setup-instructions)
- [Configuration](#-configuration)
- [API Documentation](#-api-documentation)
- [Roles & Permissions](#-roles--permissions)
- [Testing](#-testing)
- [Troubleshooting](#-troubleshooting)

---

## ğŸš€ Quick Start

Jika sudah familiar dengan Laravel, ikuti langkah ini (5 menit):

```bash
# 1. Install dependencies
composer install

# 2. Setup environment
cp .env.example .env
php artisan key:generate

# 3. Configure database di .env
# DB_DATABASE=backend_login_b4t
# DB_USERNAME=root
# DB_PASSWORD=your_password

# 4. Run migrations & seed
php artisan migrate
php artisan db:seed --class=SuperAdminSeeder

# 5. Start server
php artisan serve
# Akses: http://localhost:8000/api
```

Default credentials:
- Username: `superadmin`
- Password: `password123`

---

## ğŸ“‹ Prerequisites

Sebelum setup, pastikan sudah install:

| Tool | Version | Download |
|------|---------|----------|
| PHP | 7.3+ or 8.0+ | https://www.php.net/downloads |
| Composer | Latest | https://getcomposer.org/download |
| MySQL | 5.7+ | https://www.mysql.com/downloads |
| Git | Latest | https://git-scm.com |

**Verify installation:**
```bash
php --version
composer --version
mysql --version
git --version
```

### PHP Extensions Required
Pastikan extensions ini enabled di `php.ini`:
```
extension=openssl
extension=mbstring
extension=ctype
extension=json
extension=curl
extension=pdo
extension=pdo_mysql
```

---

## ğŸ”§ Setup Instructions

### Step 1: Clone & Navigate
```bash
git clone https://github.com/CMGcool/backend_login_b4t.git
cd backend_login_b4t
```

### Step 2: Install Composer Dependencies
```bash
composer install
```

**Packages yang diinstall:**
- `laravel/framework` (^8.75) - Framework utama
- `laravel/sanctum` (2.15) - Token authentication
- `laravel/socialite` (5.5) - Google OAuth
- `guzzlehttp/guzzle` (^7.0.1) - HTTP client
- `fruitcake/laravel-cors` (^2.0) - CORS support
- `doctrine/dbal` (^3.10) - Database tools

### Step 3: Generate Application Key
```bash
cp .env.example .env
php artisan key:generate
```

File `.env` akan berisi `APP_KEY` yang di-generate otomatis.

### Step 4: Create Database
**Via MySQL CLI:**
```bash
mysql -u root -p
CREATE DATABASE backend_login_b4t;
EXIT;
```

**Via phpMyAdmin atau GUI tool:**
- Buat database dengan nama `backend_login_b4t`

### Step 5: Configure Database
Edit file `.env`:
```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=backend_login_b4t
DB_USERNAME=root
DB_PASSWORD=your_mysql_password
```

### Step 6: Run Database Migrations
```bash
php artisan migrate
```

Tables yang dibuat:
- `users` - User data
- `password_resets` - Password reset tokens
- `personal_access_tokens` - Sanctum API tokens
- `failed_jobs` - Failed job queue

### Step 7: Seed Super Admin
```bash
php artisan db:seed --class=SuperAdminSeeder
```

Credentials:
- Username: `superadmin`
- Password: `password123`
- Role: `super_admin`

### Step 8: Start Server
```bash
php artisan serve
```

Output:
```
Laravel development server started: http://127.0.0.1:8000
```

Server berjalan di: **http://localhost:8000**

---

## âš™ï¸ Configuration

### Environment Variables (.env)

#### Basic Configuration
```env
APP_NAME=Backend Login B4T
APP_ENV=local                           # local, staging, production
APP_KEY=base64:xxxxx                   # Generated by php artisan key:generate
APP_DEBUG=true                         # false in production
APP_URL=http://localhost:8000

LOG_CHANNEL=stack
LOG_LEVEL=debug
```

#### Database
```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=backend_login_b4t
DB_USERNAME=root
DB_PASSWORD=your_password
```

#### Cache & Session
```env
CACHE_DRIVER=file                      # redis, memcached, file
SESSION_DRIVER=file                    # cookie, file, database
QUEUE_CONNECTION=sync                  # sync, redis, database
```

#### Google OAuth (Optional)
```env
GOOGLE_CLIENT_ID=your_client_id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your_client_secret
GOOGLE_REDIRECT_URI=http://localhost:8000/api/auth/google/callback
```

Dapatkan credentials dari: [Google Cloud Console](https://console.cloud.google.com)

#### Frontend URL (CORS)
```env
FRONTEND_URL=http://localhost:3000
```

---

## ğŸ“š API Documentation

### Base URL
```
http://localhost:8000/api
```

### Authentication
API menggunakan **Laravel Sanctum** (token-based authentication).

Semua endpoint yang authenticated memerlukan header:
```
Authorization: Bearer {token}
```

---

## Public Endpoints (Tanpa Autentikasi)

### 1. Register User
**POST** `/register`

Mendaftarkan user baru. User akan menunggu approval dari admin/super admin.

**Request:**
```bash
curl -X POST http://localhost:8000/api/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "John Doe",
    "username": "johndoe",
    "email": "john@example.com",
    "password": "password123"
  }'
```

**Body:**
```json
{
    "name": "John Doe",           // required, string
    "username": "johndoe",        // required, string, unique
    "email": "john@example.com",  // nullable, email, unique
    "password": "password123"     // required, min 6 karakter
}
```

**Response (201):**
```json
{
    "message": "Register berhasil, menunggu approval admin"
}
```

---

### 2. Login
**POST** `/login`

Login dengan username dan password.

**Request:**
```bash
curl -X POST http://localhost:8000/api/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "superadmin",
    "password": "password123"
  }'
```

**Body:**
```json
{
    "username": "superadmin",  // required
    "password": "password123"  // required
}
```

**Response Success (200):**
```json
{
    "token": "1|abc123xyz789...",
    "role": "super_admin",
    "user": {
        "id": 1,
        "name": "Super Admin",
        "username": "superadmin",
        "email": "superadmin@example.com",
        "role": "super_admin",
        "is_approved": 1,
        "created_at": "2025-12-31T10:00:00.000000Z"
    }
}
```

**Response Error:**
- **401** - Username atau password salah
- **403** - Akun belum di-approve
- **403** - Akun menggunakan Google OAuth login

---

### 3. Google OAuth - Redirect
**GET** `/auth/google/redirect`

Redirect ke halaman login Google.

**Request:**
```bash
curl http://localhost:8000/api/auth/google/redirect
```

**Response:**
Redirect ke Google OAuth consent screen.

---

### 4. Google OAuth - Callback
**GET** `/auth/google/callback?code={code}&state={state}`

Callback dari Google setelah user login. User otomatis dibuat & approved jika baru.

**Response:**
Redirect ke: `http://localhost:3000/sso?token={token}&role={role}`

---

## Protected Endpoints (Memerlukan Token)

### Admin Endpoints (Role: admin)

#### 1. Get All Users
**GET** `/admin/users`

Melihat daftar user (tidak termasuk admin/super_admin).

**Request:**
```bash
curl -X GET http://localhost:8000/api/admin/users \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "data": [
        {
            "id": 2,
            "name": "John Doe",
            "username": "johndoe",
            "email": "john@example.com",
            "role": "user",
            "is_approved": 1,
            "created_at": "2025-12-31T10:00:00.000000Z"
        }
    ]
}
```

---

#### 2. Create User
**POST** `/admin/create-user`

Admin membuat user baru yang langsung aktif (tidak perlu approval).

**Request:**
```bash
curl -X POST http://localhost:8000/api/admin/create-user \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "Jane Doe",
    "username": "janedoe",
    "email": "jane@example.com",
    "password": "password123"
  }'
```

**Body:**
```json
{
    "name": "Jane Doe",          // required, string
    "username": "janedoe",       // required, string, unique
    "email": "jane@example.com", // nullable, email, unique
    "password": "password123"    // required, min 6 karakter
}
```

**Response (201):**
```json
{
    "message": "User berhasil dibuat",
    "data": {
        "id": 5,
        "name": "Jane Doe",
        "username": "janedoe",
        "email": "jane@example.com",
        "role": "user",
        "is_approved": 1
    }
}
```

---

#### 3. Update User
**PUT** `/users/{id}`

Admin update user. Admin hanya bisa update user biasa (tidak bisa admin/super_admin).

**Request:**
```bash
curl -X PUT http://localhost:8000/api/users/2 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "Jane Updated",
    "username": "janeupdated",
    "email": "janeupdated@example.com",
    "password": "newpassword123"
  }'
```

**Body:**
```json
{
    "name": "Jane Updated",              // optional
    "username": "janeupdated",           // optional, unique
    "email": "janeupdated@example.com",  // optional, email
    "password": "newpassword123"         // optional, min 6 karakter
}
```

**Response (200):**
```json
{
    "message": "User berhasil diupdate",
    "data": {
        "id": 2,
        "name": "Jane Updated",
        "username": "janeupdated",
        "email": "janeupdated@example.com",
        "role": "user",
        "is_approved": 1
    }
}
```

**Error (403):**
```json
{
    "message": "Admin hanya bisa update user"
}
```

---

#### 4. Delete User
**DELETE** `/users/{id}`

Admin hapus user. Hanya user biasa yang bisa dihapus, admin/super_admin tidak bisa.

**Request:**
```bash
curl -X DELETE http://localhost:8000/api/users/2 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "message": "User berhasil dihapus"
}
```

**Error (403):**
```json
{
    "message": "Hanya user yang bisa dihapus"
}
```

---

#### 5. Approve User
**POST** `/approve-user/{id}`

Admin/Super Admin approve user yang pending.

**Request:**
```bash
curl -X POST http://localhost:8000/api/approve-user/2 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "message": "User approved successfully",
    "user": {
        "id": 2,
        "name": "John Doe",
        "username": "johndoe",
        "email": "john@example.com",
        "is_approved": 1
    }
}
```

**Error (400):**
```json
{
    "message": "User already approved"
}
```

---

#### 6. Get Dashboard Stats
**GET** `/admin/dashboard-stats`

Get statistik dashboard untuk admin.

**Request:**
```bash
curl -X GET http://localhost:8000/api/admin/dashboard-stats \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "data": {
        "total_users": 10,
        "total_approved": 9,
        "total_pending": 1
    }
}
```

---

### Super Admin Endpoints (Role: super_admin)

#### 1. Create Admin
**POST** `/super-admin/create-admin`

Super admin membuat admin baru.

**Request:**
```bash
curl -X POST http://localhost:8000/api/super-admin/create-admin \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "Admin User",
    "username": "adminuser",
    "email": "admin@example.com",
    "password": "password123"
  }'
```

**Body:**
```json
{
    "name": "Admin User",        // required, string
    "username": "adminuser",     // required, string, unique
    "email": "admin@example.com",// required, email, unique
    "password": "password123"    // required, min 6 karakter
}
```

**Response (201):**
```json
{
    "message": "Admin berhasil dibuat",
    "data": {
        "id": 3,
        "name": "Admin User",
        "username": "adminuser",
        "email": "admin@example.com",
        "role": "admin",
        "is_approved": 1
    }
}
```

---

#### 2. Create User
**POST** `/super-admin/create-user`

Super admin membuat user baru yang langsung aktif.

**Request:**
```bash
curl -X POST http://localhost:8000/api/super-admin/create-user \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "New User",
    "username": "newuser",
    "email": "newuser@example.com",
    "password": "password123"
  }'
```

**Response (201):**
```json
{
    "message": "User berhasil dibuat"
}
```

---

#### 3. Get All Users & Admins
**GET** `/super-admin/users`

Melihat daftar user dan admin (tidak termasuk super_admin).

**Request:**
```bash
curl -X GET http://localhost:8000/api/super-admin/users \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "data": [
        {
            "id": 2,
            "name": "Admin User",
            "username": "adminuser",
            "email": "admin@example.com",
            "role": "admin",
            "is_approved": 1,
            "created_at": "2025-12-31T09:00:00.000000Z"
        },
        {
            "id": 3,
            "name": "John Doe",
            "username": "johndoe",
            "email": "john@example.com",
            "role": "user",
            "is_approved": 1,
            "created_at": "2025-12-31T10:00:00.000000Z"
        }
    ]
}
```

---

#### 4. Update Any User/Admin
**PUT** `/users/{id}`

Super admin update siapa saja (user, admin, super_admin lain).

**Request:**
```bash
curl -X PUT http://localhost:8000/api/users/2 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "Updated Name",
    "username": "updatedusername"
  }'
```

**Body:**
```json
{
    "name": "Updated Name",        // optional
    "username": "updated",         // optional, unique
    "email": "updated@example.com",// optional, email
    "password": "newpassword"      // optional, min 6 karakter
}
```

**Response (200):**
```json
{
    "message": "User berhasil diupdate",
    "data": {
        "id": 2,
        "name": "Updated Name",
        "username": "updated",
        "email": "updated@example.com",
        "role": "admin",
        "is_approved": 1
    }
}
```

---

#### 5. Delete User
**DELETE** `/users/{id}`

Super admin hapus user. Hanya user biasa yang bisa dihapus (admin tidak bisa).

**Request:**
```bash
curl -X DELETE http://localhost:8000/api/users/3 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "message": "User berhasil dihapus"
}
```

**Error (403):**
```json
{
    "message": "Hanya user yang bisa dihapus"
}
```

---

#### 6. Get Dashboard Stats
**GET** `/super-admin/dashboard-stats`

Get statistik dashboard lengkap.

**Request:**
```bash
curl -X GET http://localhost:8000/api/super-admin/dashboard-stats \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "data": {
        "total_users": 10,
        "total_admins": 3,
        "total_approved": 13,
        "total_pending": 0,
        "total_all": 13
    }
}
```

---

### User Endpoints (Role: user)

#### 1. User Welcome
**GET** `/user/welcome`

User welcome page.

**Request:**
```bash
curl -X GET http://localhost:8000/api/user/welcome \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "message": "Welcome John Doe",
    "role": "user"
}
```

---

### Common Endpoints

#### 1. Logout
**POST** `/logout`

Logout dan hapus token.

**Request:**
```bash
curl -X POST http://localhost:8000/api/logout \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "message": "Logout berhasil"
}
```

---

## ğŸ‘¥ Roles & Permissions

| Action | Super Admin | Admin | User |
|--------|:-----------:|:-----:|:----:|
| **Create User** | âœ… | âœ… | âŒ |
| **Create Admin** | âœ… | âŒ | âŒ |
| **Edit User** | âœ… | âš ï¸* | âŒ |
| **Edit Admin** | âœ… | âŒ | âŒ |
| **Delete User** | âœ… | âš ï¸* | âŒ |
| **Delete Admin** | âœ… | âŒ | âŒ |
| **View Users** | âœ… | âœ… | âŒ |
| **View Admins** | âœ… | âŒ | âŒ |
| **Approve User** | âœ… | âœ… | âŒ |
| **View Dashboard** | âœ… | âœ… | âœ… |

**Legend:**
- âœ… = Diizinkan
- âŒ = Tidak diizinkan
- âš ï¸* = Bersyarat (hanya user biasa)

---

## ğŸ§ª Testing

### Using cURL

**Test Login:**
```bash
curl -X POST http://localhost:8000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"superadmin","password":"password123"}'
```

**Save Token:**
```bash
TOKEN="1|abc123xyz..."  # Copy dari response login
```

**Test Protected Endpoint:**
```bash
curl -X GET http://localhost:8000/api/super-admin/users \
  -H "Authorization: Bearer $TOKEN"
```

### Using Postman or Thunder Client

1. **Create Request Collection**
   - Name: "Backend Login B4T"
   - Method: POST
   - URL: `http://localhost:8000/api/login`
   - Body (JSON):
     ```json
     {
       "username": "superadmin",
       "password": "password123"
     }
     ```

2. **Copy Token**
   - Dari response login, copy `token` value

3. **Set Authorization**
   - Tab "Headers" atau "Auth"
   - Key: `Authorization`
   - Value: `Bearer {TOKEN}`

4. **Test Endpoints**
   - GET `http://localhost:8000/api/super-admin/users`
   - GET `http://localhost:8000/api/admin/dashboard-stats`
   - Etc.

---

## ğŸ”§ Common Commands

```bash
# Start server
php artisan serve

# Start dengan custom port
php artisan serve --port=8001

# Database migrations
php artisan migrate              # Run all
php artisan migrate:rollback     # Undo last batch
php artisan migrate:refresh      # Reset & run

# Database seeding
php artisan db:seed                          # Seed all
php artisan db:seed --class=SuperAdminSeeder # Specific seeder

# Fresh setup
php artisan migrate:fresh --seed  # Reset database & seed

# Interactive shell
php artisan tinker

# Clear cache
php artisan cache:clear
php artisan config:clear
php artisan view:clear

# View logs
tail -f storage/logs/laravel.log  # Linux/macOS
type storage\logs\laravel.log     # Windows
```

### Tinker Examples

```bash
php artisan tinker

# Count users
>>> App\Models\User::count()

# Get all admins
>>> App\Models\User::where('role', 'admin')->get()

# Find user
>>> App\Models\User::find(1)

# Create user
>>> App\Models\User::create([
    'name' => 'Test User',
    'username' => 'testuser',
    'email' => 'test@example.com',
    'password' => bcrypt('password'),
    'role' => 'user',
    'is_approved' => 1
])

# Update user
>>> $user = App\Models\User::find(1)
>>> $user->update(['name' => 'Updated Name'])

# Delete user
>>> $user->delete()

# Exit
>>> exit
```

---

## ğŸ› Troubleshooting

### Issue 1: "Call to undefined function base64_encode()"
**Cause:** PHP extensions tidak enabled.
**Solution:**
```bash
# Edit php.ini uncomment:
extension=openssl
extension=mbstring
extension=ctype
extension=json

# Restart PHP
```

### Issue 2: "SQLSTATE[HY000] [2002] Connection refused"
**Cause:** MySQL tidak running.
**Solution:**
```bash
# Windows
net start MySQL80

# macOS
brew services start mysql@8.0

# Linux
sudo systemctl start mysql
```

### Issue 3: "No application key has been generated"
**Solution:**
```bash
php artisan key:generate
```

### Issue 4: "CORS policy: No 'Access-Control-Allow-Origin' header"
**Check:** `config/cors.php` harus include frontend URL:
```php
'allowed_origins' => ['http://localhost:3000'],
```

Clear cache:
```bash
php artisan cache:clear
```

### Issue 5: "Port 8000 already in use"
**Solution:**
```bash
# Use different port
php artisan serve --port=8001

# Or kill process
lsof -ti:8000 | xargs kill -9     # Linux/macOS
netstat -ano | findstr :8000      # Windows (find PID)
taskkill /PID <pid> /F            # Windows (kill)
```

### Issue 6: "Composer install fails"
**Solution:**
```bash
# Update composer
composer self-update

# Clear cache
composer clear-cache

# Try again
composer install
```

---

## ğŸ“ Important Notes

- User yang register manual perlu approval dari admin/super_admin
- User yang login via Google langsung approved
- Admin hanya bisa dibuat oleh super_admin
- Token tidak ada expiry (persistent)
- CORS dikonfigurasi untuk `http://localhost:3000`
- Semua passwords hashed menggunakan bcrypt
- Database timestamps dalam UTC

---

## ğŸ“„ File Structure

```
backend_login_b4t/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ Http/
â”‚   â”‚   â”œâ”€â”€ Controllers/
â”‚   â”‚   â”‚   â””â”€â”€ UserManagementController.php
â”‚   â”‚   â”œâ”€â”€ Middleware/
â”‚   â”‚   â”‚   â””â”€â”€ CheckRole.php
â”‚   â”‚   â””â”€â”€ Kernel.php
â”‚   â”œâ”€â”€ Models/
â”‚   â”‚   â””â”€â”€ User.php
â”‚   â””â”€â”€ Providers/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ auth.php
â”‚   â”œâ”€â”€ cors.php
â”‚   â”œâ”€â”€ database.php
â”‚   â””â”€â”€ sanctum.php
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ create_users_table.php
â”‚   â”‚   â””â”€â”€ create_personal_access_tokens_table.php
â”‚   â””â”€â”€ seeders/
â”‚       â””â”€â”€ SuperAdminSeeder.php
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ api.php               # API Routes
â”‚   â””â”€â”€ web.php
â”œâ”€â”€ storage/logs/             # Logs
â”œâ”€â”€ .env.example
â”œâ”€â”€ composer.json
â””â”€â”€ README.md
```

---

## ğŸ”— Useful Resources

- [Laravel 8 Docs](https://laravel.com/docs/8.x)
- [Sanctum Docs](https://laravel.com/docs/sanctum)
- [Socialite Docs](https://laravel.com/docs/socialite)
- [RESTful API Best Practices](https://restfulapi.net)
- [HTTP Status Codes](https://httpwg.org/specs/rfc7231.html#status.codes)

---

## ğŸ“ Support

**Jika ada error:**

1. Check `storage/logs/laravel.log`
2. Check database connection
3. Run `php artisan migrate` again
4. Clear cache: `php artisan cache:clear`
5. Verify `.env` configuration

---

Last Updated: December 31, 2025
Version: 1.0.0
