# Backend Login B4T - Setup & API Documentation

Backend RESTful API untuk sistem autentikasi dengan role-based access control, dibangun dengan Laravel 8 dan Laravel Sanctum.

---

## üìã Table of Contents

- [Quick Start](#-quick-start)
- [Prerequisites](#-prerequisites)
- [Setup Instructions](#-setup-instructions)
- [Configuration](#-configuration)
- [API Documentation](#-api-documentation)
- [Payment System (BNI eCollection)](#-payment-system---bni-ecollection)
- [Roles & Permissions](#-roles--permissions)
- [Testing](#-testing)
- [Troubleshooting](#-troubleshooting)

---

## üöÄ Quick Start

Jika sudah familiar dengan Laravel, ikuti langkah ini (5 menit):

```bash
# 1. Install dependencies
composer install

# 2. Setup environment
cp .env.example .env
php artisan key:generate

# 3. Configure database di .env
# DB_DATABASE=backend_login_b4t
# DB_USERNAME=root
# DB_PASSWORD=your_password

# 4. Run migrations & seed
php artisan migrate
php artisan db:seed --class=SuperAdminSeeder

# 5. Start server
php artisan serve
# Akses: http://localhost:8000/api
```

Default credentials:
Super Admin
- Username: `superadmin`
- Password: `password123`

Admin
- Username: `admin1`
- Password: `password123`


---

## üìã Prerequisites

Sebelum setup, pastikan sudah install:

| Tool | Version | Download |
|------|---------|----------|
| PHP | 7.3+ or 8.0+ | https://www.php.net/downloads |
| Composer | Latest | https://getcomposer.org/download |
| MySQL | 5.7+ | https://www.mysql.com/downloads |
| Git | Latest | https://git-scm.com |

**Verify installation:**
```bash
php --version
composer --version
mysql --version
git --version
```

### PHP Extensions Required
Pastikan extensions ini enabled di `php.ini`:
```
extension=openssl
extension=mbstring
extension=ctype
extension=json
extension=curl
extension=pdo
extension=pdo_mysql
```

---

## üîß Setup Instructions

### Step 1: Clone & Navigate
```bash
git clone https://github.com/CMGcool/backend_login_b4t.git
cd backend_login_b4t
```

### Step 2: Install Composer Dependencies
```bash
composer install
```

**Packages yang diinstall:**
- `laravel/framework` (^8.75) - Framework utama
- `laravel/sanctum` (2.15) - Token authentication
- `laravel/socialite` (5.5) - Google OAuth
- `guzzlehttp/guzzle` (^7.0.1) - HTTP client
- `fruitcake/laravel-cors` (^2.0) - CORS support
- `doctrine/dbal` (^3.10) - Database tools

### Step 3: Generate Application Key
```bash
cp .env.example .env
php artisan key:generate
```

File `.env` akan berisi `APP_KEY` yang di-generate otomatis.

### Step 4: Create Database
**Via MySQL CLI:**
```bash
mysql -u root -p
CREATE DATABASE backend_login_b4t;
EXIT;
```

**Via phpMyAdmin atau GUI tool:**
- Buat database dengan nama `backend_login_b4t`

### Step 5: Configure Database
Edit file `.env`:
```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=backend_login_b4t
DB_USERNAME=root
DB_PASSWORD=your_mysql_password
```

### Step 6: Run Database Migrations
```bash
php artisan migrate
```

Tables yang dibuat:
- `users` - User data
- `password_resets` - Password reset tokens
- `personal_access_tokens` - Sanctum API tokens
- `failed_jobs` - Failed job queue

### Step 7: Seed Super Admin
```bash
php artisan db:seed --class=SuperAdminSeeder
php artisan db:seed --class=AdminSeeder
```

Credentials:
- Username: `superadmin`
- Password: `password123`
- Role: `super_admin`

Credentials:
- Username: `admin1`
- Password: `password123`
- Role: `admin`

### Step 8: Start Server
```bash
php artisan serve
```

Output:
```
Laravel development server started: http://127.0.0.1:8000
```

Server berjalan di: **http://localhost:8000**

---

## ‚öôÔ∏è Configuration

### Environment Variables (.env)

#### Basic Configuration
```env
APP_NAME=Backend Login B4T
APP_ENV=local                           # local, staging, production
APP_KEY=base64:xxxxx                   # Generated by php artisan key:generate
APP_DEBUG=true                         # false in production
APP_URL=http://localhost:8000

LOG_CHANNEL=stack
LOG_LEVEL=debug
```

#### Database
```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=backend_login_b4t
DB_USERNAME=root
DB_PASSWORD=your_password
```

#### Cache & Session
```env
CACHE_DRIVER=file                      # redis, memcached, file
SESSION_DRIVER=file                    # cookie, file, database
QUEUE_CONNECTION=sync                  # sync, redis, database
```

#### Google OAuth (Optional)
```env
GOOGLE_CLIENT_ID=your_client_id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your_client_secret
GOOGLE_REDIRECT_URI=http://localhost:8000/api/auth/google/callback
```

Dapatkan credentials dari: [Google Cloud Console](https://console.cloud.google.com)

#### Frontend URL (CORS)
```env
FRONTEND_URL=http://localhost:3000
```

---

## üìö API Documentation

### Base URL
```
http://localhost:8000/api
```

### Authentication
API menggunakan **Laravel Sanctum** (token-based authentication).

Semua endpoint yang authenticated memerlukan header:
```
Authorization: Bearer {token}
```

---

## Public Endpoints (Tanpa Autentikasi)

### 1. Register User
**POST** `/register`

Mendaftarkan user baru. User akan menunggu approval dari admin/super admin.

**Request:**
```bash
curl -X POST http://localhost:8000/api/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "John Doe",
    "username": "johndoe",
    "email": "john@example.com",
    "password": "password123"
  }'
```

**Body:**
```json
{
    "name": "John Doe",           // required, string
    "username": "johndoe",        // required, string, unique
    "email": "john@example.com",  // nullable, email, unique
    "password": "password123"     // required, min 6 karakter
}
```

**Response (201):**
```json
{
    "message": "Register berhasil, menunggu approval admin"
}
```

---

### 2. Login
**POST** `/login`

Login dengan username dan password.

**Request:**
```bash
curl -X POST http://localhost:8000/api/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "superadmin",
    "password": "password123"
  }'
```

**Body:**
```json
{
    "username": "superadmin",  // required
    "password": "password123"  // required
}
```

**Response Success (200):**
```json
{
    "token": "1|abc123xyz789...",
    "role": "super_admin",
    "user": {
        "id": 1,
        "name": "Super Admin",
        "username": "superadmin",
        "email": "superadmin@example.com",
        "role": "super_admin",
        "is_approved": 1,
        "created_at": "2025-12-31T10:00:00.000000Z"
    }
}
```

**Response Error:**
- **401** - Username atau password salah
- **403** - Akun belum di-approve
- **403** - Akun menggunakan Google OAuth login

---

### 3. Google OAuth - Redirect
**GET** `/auth/google/redirect`

Redirect ke halaman login Google.

**Request:**
```bash
curl http://localhost:8000/api/auth/google/redirect
```

**Response:**
Redirect ke Google OAuth consent screen.

---

### 4. Google OAuth - Callback
**GET** `/auth/google/callback?code={code}&state={state}`

Callback dari Google setelah user login. User otomatis dibuat & approved jika baru.

**Response:**
Redirect ke: `http://localhost:3000/sso?token={token}&role={role}`

---

## Protected Endpoints (Memerlukan Token)

### Admin Endpoints (Role: admin)

#### 1. Get All Users
**GET** `/admin/users`

Melihat daftar user (tidak termasuk admin/super_admin).

**Request:**
```bash
curl -X GET http://localhost:8000/api/admin/users \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "data": [
        {
            "id": 2,
            "name": "John Doe",
            "username": "johndoe",
            "email": "john@example.com",
            "role": "user",
            "is_approved": 1,
            "created_at": "2025-12-31T10:00:00.000000Z"
        }
    ]
}
```

---

#### 2. Create User
**POST** `/admin/create-user`

Admin membuat user baru yang langsung aktif (tidak perlu approval).

**Request:**
```bash
curl -X POST http://localhost:8000/api/admin/create-user \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "Jane Doe",
    "username": "janedoe",
    "email": "jane@example.com",
    "password": "password123"
  }'
```

**Body:**
```json
{
    "name": "Jane Doe",          // required, string
    "username": "janedoe",       // required, string, unique
    "email": "jane@example.com", // nullable, email, unique
    "password": "password123"    // required, min 6 karakter
}
```

**Response (201):**
```json
{
    "message": "User berhasil dibuat",
    "data": {
        "id": 5,
        "name": "Jane Doe",
        "username": "janedoe",
        "email": "jane@example.com",
        "role": "user",
        "is_approved": 1
    }
}
```

---

#### 3. Update User
**PUT** `/users/{id}`

Admin update user. Admin hanya bisa update user biasa (tidak bisa admin/super_admin).

**Request:**
```bash
curl -X PUT http://localhost:8000/api/users/2 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "Jane Updated",
    "username": "janeupdated",
    "email": "janeupdated@example.com",
    "password": "newpassword123"
  }'
```

**Body:**
```json
{
    "name": "Jane Updated",              // optional
    "username": "janeupdated",           // optional, unique
    "email": "janeupdated@example.com",  // optional, email
    "password": "newpassword123"         // optional, min 6 karakter
}
```

**Response (200):**
```json
{
    "message": "User berhasil diupdate",
    "data": {
        "id": 2,
        "name": "Jane Updated",
        "username": "janeupdated",
        "email": "janeupdated@example.com",
        "role": "user",
        "is_approved": 1
    }
}
```

**Error (403):**
```json
{
    "message": "Admin hanya bisa update user"
}
```

---

#### 4. Delete User
**DELETE** `/users/{id}`

Admin hapus user. Hanya user biasa yang bisa dihapus, admin/super_admin tidak bisa.

**Request:**
```bash
curl -X DELETE http://localhost:8000/api/users/2 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "message": "User berhasil dihapus"
}
```

**Error (403):**
```json
{
    "message": "Hanya user yang bisa dihapus"
}
```

---

#### 5. Approve User
**POST** `/approve-user/{id}`

Admin/Super Admin approve user yang pending.

**Request:**
```bash
curl -X POST http://localhost:8000/api/approve-user/2 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "message": "User approved successfully",
    "user": {
        "id": 2,
        "name": "John Doe",
        "username": "johndoe",
        "email": "john@example.com",
        "is_approved": 1
    }
}
```

**Error (400):**
```json
{
    "message": "User already approved"
}
```

---

#### 6. Get Dashboard Stats
**GET** `/admin/dashboard-stats`

Get statistik dashboard untuk admin.

**Request:**
```bash
curl -X GET http://localhost:8000/api/admin/dashboard-stats \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "data": {
        "total_users": 10,
        "total_approved": 9,
        "total_pending": 1
    }
}
```

---

### Super Admin Endpoints (Role: super_admin)

#### 1. Create Admin
**POST** `/super-admin/create-admin`

Super admin membuat admin baru.

**Request:**
```bash
curl -X POST http://localhost:8000/api/super-admin/create-admin \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "Admin User",
    "username": "adminuser",
    "email": "admin@example.com",
    "password": "password123"
  }'
```

**Body:**
```json
{
    "name": "Admin User",        // required, string
    "username": "adminuser",     // required, string, unique
    "email": "admin@example.com",// required, email, unique
    "password": "password123"    // required, min 6 karakter
}
```

**Response (201):**
```json
{
    "message": "Admin berhasil dibuat",
    "data": {
        "id": 3,
        "name": "Admin User",
        "username": "adminuser",
        "email": "admin@example.com",
        "role": "admin",
        "is_approved": 1
    }
}
```

---

#### 2. Create User
**POST** `/super-admin/create-user`

Super admin membuat user baru yang langsung aktif.

**Request:**
```bash
curl -X POST http://localhost:8000/api/super-admin/create-user \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "New User",
    "username": "newuser",
    "email": "newuser@example.com",
    "password": "password123"
  }'
```

**Response (201):**
```json
{
    "message": "User berhasil dibuat"
}
```

---

#### 3. Get All Users & Admins
**GET** `/super-admin/users`

Melihat daftar user dan admin (tidak termasuk super_admin).

**Request:**
```bash
curl -X GET http://localhost:8000/api/super-admin/users \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "data": [
        {
            "id": 2,
            "name": "Admin User",
            "username": "adminuser",
            "email": "admin@example.com",
            "role": "admin",
            "is_approved": 1,
            "created_at": "2025-12-31T09:00:00.000000Z"
        },
        {
            "id": 3,
            "name": "John Doe",
            "username": "johndoe",
            "email": "john@example.com",
            "role": "user",
            "is_approved": 1,
            "created_at": "2025-12-31T10:00:00.000000Z"
        }
    ]
}
```

---

#### 4. Update Any User/Admin
**PUT** `/users/{id}`

Super admin update siapa saja (user, admin, super_admin lain).

**Request:**
```bash
curl -X PUT http://localhost:8000/api/users/2 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "Updated Name",
    "username": "updatedusername"
  }'
```

**Body:**
```json
{
    "name": "Updated Name",        // optional
    "username": "updated",         // optional, unique
    "email": "updated@example.com",// optional, email
    "password": "newpassword"      // optional, min 6 karakter
}
```

**Response (200):**
```json
{
    "message": "User berhasil diupdate",
    "data": {
        "id": 2,
        "name": "Updated Name",
        "username": "updated",
        "email": "updated@example.com",
        "role": "admin",
        "is_approved": 1
    }
}
```

---

#### 5. Delete User
**DELETE** `/users/{id}`

Super admin hapus user. Hanya user biasa yang bisa dihapus (admin tidak bisa).

**Request:**
```bash
curl -X DELETE http://localhost:8000/api/users/3 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "message": "User berhasil dihapus"
}
```

**Error (403):**
```json
{
    "message": "Hanya user yang bisa dihapus"
}
```

---

#### 6. Get Dashboard Stats
**GET** `/super-admin/dashboard-stats`

Get statistik dashboard lengkap.

**Request:**
```bash
curl -X GET http://localhost:8000/api/super-admin/dashboard-stats \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "data": {
        "total_users": 10,
        "total_admins": 3,
        "total_approved": 13,
        "total_pending": 0,
        "total_all": 13
    }
}
```

---

### User Endpoints (Role: user)

#### 1. User Welcome
**GET** `/user/welcome`

User welcome page.

**Request:**
```bash
curl -X GET http://localhost:8000/api/user/welcome \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "message": "Welcome John Doe",
    "role": "user"
}
```

---

### Common Endpoints

#### 1. Logout
**POST** `/logout`

Logout dan hapus token.

**Request:**
```bash
curl -X POST http://localhost:8000/api/logout \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response (200):**
```json
{
    "message": "Logout berhasil"
}
```

---

## Payment System - BNI eCollection

### Overview
Backend ini terintegrasi dengan **BNI eCollection API v3.0.3** untuk sistem pembayaran Virtual Account (VA).

**Dokumentasi:** Lihat BNI_eCollection_API_v3.0.3

### BNI eCollection Configuration

Edit `.env`:
```env
# BNI eCollection (Development)
BNI_CLIENT_ID=your_client_id
BNI_SECRET_KEY=your_secret_key
BNI_API_URL=gunakan endpoint untuk development yang diberikan oleh BNI
BNI_PREFIX=your_va_prefix

# Untuk Production, ubah ke:
# BNI_API_URL=gunakan endpoint untuk production yang diberikan oleh BNI
```

### Database Schema

Tabel `payments` menyimpan semua transaksi:
```sql
- id (Primary Key)
- trx_id (Unique transaction ID)
- virtual_account (VA yang di-generate BNI)
- user_id (User yang membuat transaksi)
- layanan_id (Service yang dibeli)
- customer_name, customer_email, customer_phone
- amount (Nominal pembayaran)
- billing_type (c = fixed payment)
- status (pending, paid, expired, failed)
- payment_ntb (NTB dari BNI saat pembayaran)
- payment_amount (Nominal yang diterima)
- paid_at (Waktu pembayaran)
- bni_response (Response dari BNI saat create billing)
- bni_callback (Data callback dari BNI saat pembayaran)
- description, created_at, updated_at
```

---

### Payment User Endpoints

#### 1. Create Transaction (Create VA)
**POST** `/api/payments`

User membuat transaksi pembayaran & generate Virtual Account dari BNI.

**Headers:**
```
Authorization: Bearer {token}
Content-Type: application/json
```

**Body:**
```json
{
    "layanan_id": 1,              // required, ID of service (exist di table layanan)
    "amount": 100000,             // required, nominal pembayaran (min 10000)
    "description": "Pembayaran untuk X"  // optional
}
```

**Response Success (201):**
```json
{
    "success": true,
    "message": "Transaction created successfully",
    "data": {
        "trx_id": "TRX-4-1768878730",
        "virtual_account": "9882701826012005",
        "amount": 100000,
        "status": "pending",
        "layanan": {
            "id": 1,
            "nama": "Service Name"
        },
        "instructions": {
            "bank": "BNI",
            "va_number": "9882701826012005",
            "amount": "Rp 100.000",
            "steps": [
                "1. Buka aplikasi mobile banking atau ATM BNI",
                "2. Pilih menu Transfer > Virtual Account",
                "3. Masukkan nomor VA: 9882701826012005",
                "4. Masukkan nominal: Rp 100.000",
                "5. Konfirmasi pembayaran"
            ]
        }
    },
    "bni_response": {
        "status": "000",
        "data": {
            "virtual_account": "9882701826012005",
            "trx_id": "TRX-4-1768878730"
        }
    }
}
```

**Response Error (422):**
```json
{
    "message": "The given data was invalid.",
    "errors": {
        "layanan_id": ["The layanan id field is required."]
    }
}
```

**Postman Testing:**
1. Set Method: **POST**
2. URL: `http://localhost:8000/api/payments`
3. Headers:
   - `Authorization: Bearer {your_token}`
   - `Content-Type: application/json`
4. Body (raw JSON):
   ```json
   {
     "layanan_id": 1,
     "amount": 100000,
     "description": "Test payment"
   }
   ```
5. Click Send

---

#### 2. List User Transactions
**GET** `/api/payments`

Melihat semua transaksi milik user yang login (paginated).

**Headers:**
```
Authorization: Bearer {token}
```

**Response (200):**
```json
{
    "success": true,
    "data": [
        {
            "trx_id": "TRX-4-1768878730",
            "virtual_account": "9882701826012005",
            "amount": 100000,
            "status": "pending",
            "paid_at": null,
            "description": "Test payment",
            "customer_name": "John Doe",
            "customer_email": "john@example.com",
            "customer_phone": "628123456789",
            "layanan": {
                "id": 1,
                "nama": "Service Name"
            },
            "created_at": "2026-01-20T10:00:00.000000Z",
            "bni_response": {
                "status": "000",
                "data": {...}
            }
        }
    ],
    "pagination": {
        "total": 10,
        "per_page": 10,
        "current_page": 1,
        "last_page": 1
    }
}
```

**Postman Testing:**
1. Method: **GET**
2. URL: `http://localhost:8000/api/payments`
3. Headers: `Authorization: Bearer {your_token}`
4. Click Send

---

#### 3. Get Transaction Detail
**GET** `/api/payments/{trx_id}`

Melihat detail transaksi spesifik termasuk BNI response & callback.

**Headers:**
```
Authorization: Bearer {token}
```

**Response (200):**
```json
{
    "success": true,
    "data": {
        "trx_id": "TRX-4-1768878730",
        "virtual_account": "9882701826012005",
        "amount": 100000,
        "status": "paid",
        "paid_at": "2026-01-20T10:15:00.000000Z",
        "description": "Test payment",
        "customer_name": "John Doe",
        "customer_email": "john@example.com",
        "customer_phone": "628123456789",
        "layanan": {
            "id": 1,
            "nama": "Service Name"
        },
        "created_at": "2026-01-20T10:00:00.000000Z",
        "bni_response": {
            "status": "000",
            "data": {
                "virtual_account": "9882701826012005",
                "trx_id": "TRX-4-1768878730"
            }
        },
        "bni_callback": {
            "trx_id": "TRX-4-1768878730",
            "virtual_account": "9882701826012005",
            "trx_amount": "100000.00",
            "payment_amount": "100000.00",
            "payment_ntb": "NTB20260120101500",
            "datetime_payment_iso8601": "2026-01-20T10:15:00+07:00",
            "va_status": "2"
        }
    }
}
```

**Postman Testing:**
1. Method: **GET**
2. URL: `http://localhost:8000/api/payments/TRX-4-1768878730`
3. Headers: `Authorization: Bearer {your_token}`
4. Click Send

---

#### 4. Update Transaction
**PUT** `/api/payments/{trx_id}`

Update transaksi (nominal, customer data, expired date) sebelum dibayar.

**Headers:**
```
Authorization: Bearer {token}
Content-Type: application/json
```

**Body (semua optional, kirim yang mau diubah):**
```json
{
    "amount": 150000,
    "customer_name": "John Doe Updated",
    "customer_email": "john.updated@example.com",
    "customer_phone": "628987654321",
    "description": "Updated description",
    "datetime_expired_iso8601": "2026-01-25T23:59:59+07:00"
}
```

**Response (200):**
```json
{
    "success": true,
    "message": "Transaction updated successfully",
    "data": {
        "trx_id": "TRX-4-1768878730",
        "virtual_account": "9882701826012005",
        "amount": 150000,
        "customer_name": "John Doe Updated",
        "customer_email": "john.updated@example.com",
        "customer_phone": "628987654321",
        "description": "Updated description",
        "status": "pending"
    },
    "bni_response": {
        "status": "000"
    },
    "note": "Customer data saved in database. BNI sandbox may not support all fields."
}
```

**Important Notes:**
- Hanya bisa update transaksi dengan status `pending`
- Data tersimpan di database kita meskipun BNI sandbox tidak support
- VA number tidak bisa diubah

**Postman Testing:**
1. Method: **PUT**
2. URL: `http://localhost:8000/api/payments/TRX-4-1768878730`
3. Headers:
   - `Authorization: Bearer {your_token}`
   - `Content-Type: application/json`
4. Body (raw JSON):
   ```json
   {
     "amount": 150000,
     "customer_name": "John Updated"
   }
   ```
5. Click Send

---

### BNI Testing Endpoints (Admin/Super Admin Only)

#### 1. Create Billing (Testing)
**POST** `/api/bni/create`

Testing endpoint untuk membuat billing langsung di BNI (tanpa user flow).

**Headers:**
```
Authorization: Bearer {token}
Content-Type: application/json
```

**Body:**
```json
{
    "trx_amount": "100000",
    "billing_type": "c",
    "customer_name": "John Test",
    "customer_email": "test@example.com",
    "customer_phone": "628123456789",
    "description": "Testing billing"
}
```

**Response:**
```json
{
    "status": "000",
    "data": {
        "virtual_account": "9882701826012001",
        "trx_id": "INV-DEV-1768878730"
    }
}
```

---

#### 2. Update Billing (Testing)
**POST** `/api/bni/update-billing`

Testing endpoint untuk update billing.

**Headers:**
```
Authorization: Bearer {token}
Content-Type: application/json
```

**Body:**
```json
{
    "trx_id": "INV-DEV-1768878730",
    "trx_amount": "150000",
    "customer_name": "John Updated",
    "customer_email": "john@example.com",
    "customer_phone": "628123456789"
}
```

**Response:**
```json
{
    "status": "000",
    "message": "Billing updated successfully"
}
```

---

#### 3. Inquiry Billing (Testing & Reconciliation)
**POST** `/api/bni/inquiry`

Check status billing dari BNI (untuk reconciliation atau debugging).

**Headers:**
```
Authorization: Bearer {token}
Content-Type: application/json
```

**Body:**
```json
{
    "trx_id": "INV-DEV-1768878730"
}
```

**Response:**
```json
{
    "status": "000",
    "data": {
        "trx_id": "INV-DEV-1768878730",
        "virtual_account": "9882701826012001",
        "trx_amount": "150000",
        "customer_name": "John Updated",
        "customer_email": "john@example.com",
        "customer_phone": "628123456789",
        "billing_type": "c",
        "va_status": "1",
        "payment_ntb": null,
        "payment_amount": "0",
        "datetime_created_iso8601": "2026-01-20T10:00:00+07:00",
        "datetime_payment_iso8601": null
    }
}
```

**VA Status:**
- `1` = Active / Unpaid
- `2` = Paid / Inactive

---

#### 4. Test Callback (Development Only)
**POST** `/api/bni/test-callback`

Generate encrypted callback payload untuk testing (hanya di non-production environment).

**Headers:**
```
Authorization: Bearer {token}
```

**Query Parameters (optional):**
```
?trx_id=TRX-4-1768878730
&va_status=2
&payment_amount=100000
```

**Response:**
```json
{
    "message": "Test callback payload created. Use the encrypted_data below to test callback endpoint.",
    "test_payload": {
        "url": "/api/bni/callback",
        "method": "POST",
        "body": {
            "client_id": "your_client_id",
            "prefix": "your_va_prefix",
            "data": "encrypted_data_here"
        }
    },
    "sample_data": {
        "trx_id": "TRX-4-1768878730",
        "virtual_account": "9882701826012005",
        "trx_amount": "100000.00",
        "payment_amount": "100000.00",
        "payment_ntb": "NTB20260120101500",
        "va_status": "2"
    },
    "instructions": [
        "1. Copy the test_payload above",
        "2. POST it to /api/bni/callback endpoint",
        "3. You should get response: {\"status\": \"000\"}",
        "4. Check database: payment status should change to \"paid\"",
        "5. Check logs: storage/logs/laravel.log"
    ]
}
```

**Postman Testing:**
1. Method: **POST**
2. URL: `http://localhost:8000/api/bni/test-callback?trx_id=TRX-4-1768878730`
3. Headers: `Authorization: Bearer {your_admin_token}`
4. Copy `test_payload.body`
5. Create new request:
   - Method: **POST**
   - URL: `http://localhost:8000/api/bni/callback`
   - Body (raw JSON): Paste `test_payload.body`
6. Send ‚Üí Response should be `{"status": "000"}`

---

### BNI Callback Endpoint (Public)

#### Callback from BNI
**POST** `/api/bni/callback`

**Public endpoint** - Menerima callback dari BNI saat pembayaran terdeteksi.

**Body (dari BNI):**
```json
{
    "client_id": "your_client_id",
    "prefix": "your_va_prefix",
    "data": "encrypted_callback_from_bni"
}
```

**Response (200):**
```json
{
    "status": "000"
}
```

**What Happens:**
1. Backend decrypt callback
2. Validate va_status = 2 (paid)
3. Find payment di database
4. Update status: pending ‚Üí paid
5. Save payment details (payment_ntb, payment_amount, bni_callback)
6. (Optional) Send email notification
7. Return 000 to BNI (stop retry)

**Logs:**
Check `storage/logs/laravel.log` untuk verify:
```
[timestamp] local.INFO: BNI Callback Received {"trx_id":"TRX-4-...","va_status":"2",...}
[timestamp] local.INFO: BNI Callback - Payment Updated {"trx_id":"TRX-4-...","status":"paid",...}
```

#### Production Callback Flow

Tidak berbeda dari development:
```
User transfer ke VA
‚Üí BNI detect pembayaran
‚Üí BNI kirim callback otomatis
‚Üí Backend update DB
‚Üí Status berubah paid (real-time)
```

---

### Important Notes - Payment System

- **Development:** Callback manual via test-endpoint (VA tidak real)
- **Production:** Callback otomatis dari BNI (VA real, bisa transfer)
- **Database First:** Data customer tersimpan di DB kita, bukan rely BNI
- **Idempotent:** Callback bisa di-retry, update DB aman di-execute berkali-kali
- **Immutable:** Transaksi dengan status paid tidak bisa diubah
- **Encryption:** BNI library handle AES encryption/decryption
- **Timestamp:** Validasi ¬±5 menit untuk security

---

## ÔøΩüë• Roles & Permissions

| Action | Super Admin | Admin | User |
|--------|:-----------:|:-----:|:----:|
| **Create User** | ‚úÖ | ‚úÖ | ‚ùå |
| **Create Admin** | ‚úÖ | ‚ùå | ‚ùå |
| **Edit User** | ‚úÖ | ‚ö†Ô∏è* | ‚ùå |
| **Edit Admin** | ‚úÖ | ‚ùå | ‚ùå |
| **Delete User** | ‚úÖ | ‚ö†Ô∏è* | ‚ùå |
| **Delete Admin** | ‚úÖ | ‚ùå | ‚ùå |
| **View Users** | ‚úÖ | ‚úÖ | ‚ùå |
| **View Admins** | ‚úÖ | ‚ùå | ‚ùå |
| **Approve User** | ‚úÖ | ‚úÖ | ‚ùå |
| **View Dashboard** | ‚úÖ | ‚úÖ | ‚úÖ |

**Legend:**
- ‚úÖ = Diizinkan
- ‚ùå = Tidak diizinkan
- ‚ö†Ô∏è* = Bersyarat (hanya user biasa)

---

## üß™ Testing

### Using cURL

**Test Login:**
```bash
curl -X POST http://localhost:8000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"superadmin","password":"password123"}'
```

**Save Token:**
```bash
TOKEN="1|abc123xyz..."  # Copy dari response login
```

**Test Protected Endpoint:**
```bash
curl -X GET http://localhost:8000/api/super-admin/users \
  -H "Authorization: Bearer $TOKEN"
```

### Using Postman or Thunder Client

1. **Create Request Collection**
   - Name: "Backend Login B4T"
   - Method: POST
   - URL: `http://localhost:8000/api/login`
   - Body (JSON):
     ```json
     {
       "username": "superadmin",
       "password": "password123"
     }
     ```

2. **Copy Token**
   - Dari response login, copy `token` value

3. **Set Authorization**
   - Tab "Headers" atau "Auth"
   - Key: `Authorization`
   - Value: `Bearer {TOKEN}`

4. **Test Endpoints**
   - GET `http://localhost:8000/api/super-admin/users`
   - GET `http://localhost:8000/api/admin/dashboard-stats`
   - Etc.

---

## üîß Common Commands

```bash
# Start server
php artisan serve

# Start dengan custom port
php artisan serve --port=8001

# Database migrations
php artisan migrate              # Run all
php artisan migrate:rollback     # Undo last batch
php artisan migrate:refresh      # Reset & run

# Database seeding
php artisan db:seed                          # Seed all
php artisan db:seed --class=SuperAdminSeeder # Specific seeder

# Fresh setup
php artisan migrate:fresh --seed  # Reset database & seed

# Interactive shell
php artisan tinker

# Clear cache
php artisan cache:clear
php artisan config:clear
php artisan view:clear

# View logs
tail -f storage/logs/laravel.log  # Linux/macOS
type storage\logs\laravel.log     # Windows
```

### Tinker Examples

```bash
php artisan tinker

# Count users
>>> App\Models\User::count()

# Get all admins
>>> App\Models\User::where('role', 'admin')->get()

# Find user
>>> App\Models\User::find(1)

# Create user
>>> App\Models\User::create([
    'name' => 'Test User',
    'username' => 'testuser',
    'email' => 'test@example.com',
    'password' => bcrypt('password'),
    'role' => 'user',
    'is_approved' => 1
])

# Update user
>>> $user = App\Models\User::find(1)
>>> $user->update(['name' => 'Updated Name'])

# Delete user
>>> $user->delete()

# Exit
>>> exit
```

---

## üêõ Troubleshooting

### Issue 1: "Call to undefined function base64_encode()"
**Cause:** PHP extensions tidak enabled.
**Solution:**
```bash
# Edit php.ini uncomment:
extension=openssl
extension=mbstring
extension=ctype
extension=json

# Restart PHP
```

### Issue 2: "SQLSTATE[HY000] [2002] Connection refused"
**Cause:** MySQL tidak running.
**Solution:**
```bash
# Windows
net start MySQL80

# macOS
brew services start mysql@8.0

# Linux
sudo systemctl start mysql
```

### Issue 3: "No application key has been generated"
**Solution:**
```bash
php artisan key:generate
```

### Issue 4: "CORS policy: No 'Access-Control-Allow-Origin' header"
**Check:** `config/cors.php` harus include frontend URL:
```php
'allowed_origins' => ['http://localhost:3000'],
```

Clear cache:
```bash
php artisan cache:clear
```

### Issue 5: "Port 8000 already in use"
**Solution:**
```bash
# Use different port
php artisan serve --port=8001

# Or kill process
lsof -ti:8000 | xargs kill -9     # Linux/macOS
netstat -ano | findstr :8000      # Windows (find PID)
taskkill /PID <pid> /F            # Windows (kill)
```

### Issue 6: "Composer install fails"
**Solution:**
```bash
# Update composer
composer self-update

# Clear cache
composer clear-cache

# Try again
composer install
```

---

## üìù Important Notes

- User yang register manual perlu approval dari admin/super_admin
- User yang login via Google langsung approved
- Admin hanya bisa dibuat oleh super_admin
- Token tidak ada expiry (persistent)
- CORS dikonfigurasi untuk `http://localhost:3000`
- Semua passwords hashed menggunakan bcrypt
- Database timestamps dalam UTC
- **Payment System:**
  - Virtual Account tersedia di development (fake VA untuk testing)
  - Production menggunakan real BNI VA (bisa transfer nyata)
  - Callback dapat ditest dengan ngrok sebelum production deployment
  - Data customer disimpan di database kita sebagai backup

---

## üîó Useful Resources

- [Laravel 8 Docs](https://laravel.com/docs/8.x)
- [Sanctum Docs](https://laravel.com/docs/sanctum)
- [Socialite Docs](https://laravel.com/docs/socialite)
- [RESTful API Best Practices](https://restfulapi.net)
- [HTTP Status Codes](https://httpwg.org/specs/rfc7231.html#status.codes)

---

## üìû Support

**Jika ada error:**

1. Check `storage/logs/laravel.log`
2. Check database connection
3. Run `php artisan migrate` again
4. Clear cache: `php artisan cache:clear`
5. Verify `.env` configuration

---

Last Updated: January 20, 2026
Version: 1.1.0 (Added BNI eCollection Payment Integration)
